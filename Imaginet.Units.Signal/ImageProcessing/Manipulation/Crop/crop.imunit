<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<Imaginet version="2.0.0.0">
	<Unit name="Imaginet.Units.Math.Crop">
		<DisplayName>Image Crop</DisplayName>
		<DisplayPath>/Image Processing/Image Manipulation</DisplayPath>
		<Description>
			<Header>Description</Header>
			Extract a rectangular region from an image by cropping along height and width dimensions while preserving all channels.
			
			This unit crops an image by specifying starting indices and dimensions for both height and width. The channel dimension is preserved unchanged. Supports both 2D grayscale images (HxW) and 3D multi-channel images (HxWxC). The output shape is [count_height, count_width] for grayscale or [count_height, count_width, channels] for multi-channel images.
			
			Supports float32 data type only.

			<Header>Usage</Header>
			Use the Image Crop unit to extract regions of interest, remove borders, focus on specific image areas, or prepare images for models requiring specific input dimensions.
		</Description>

		<Parameters>
			<InputSocket name="input" pipe="data" description="Input image tensor with shape [height, width] for grayscale or [height, width, channels] for multi-channel images. Supports float32 data type only." />

			<Int32Option
			  name="start_height"
			  min="0"
			  ui="textbox"
			  text="Start Height"
			  description="Starting row index (0-based) for the crop region. Must be less than input height." />

			<Int32Option
			  name="count_height"
			  min="1"
			  ui="textbox"
			  text="Crop Height"
			  description="Number of rows to include in the cropped output. Must satisfy: start_height + count_height ≤ input_height." />

			<Int32Option
			  name="start_width"
			  min="0"
			  ui="textbox"
			  text="Start Width"
			  description="Starting column index (0-based) for the crop region. Must be less than input width." />

			<Int32Option
			  name="count_width"
			  min="1"
			  ui="textbox"
			  text="Crop Width"
			  description="Number of columns to include in the cropped output. Must satisfy: start_width + count_width ≤ input_width." />

			<!-- Precomputed values -->
			<Expression name="channels" value="input.shape.count == 2 ? 1 : input.shape.size(-3)" description="Number of channels in the input image (1 for grayscale, extracted from shape for multi-channel)." />
			<Expression name="index_offset" value="channels == 3 ? 1 : 0" description="Internal offset for indexing dimensions based on channel count." />
			<Expression name="input_height" value="input.shape.size(1+index_offset)" description="Height of the input image extracted from the tensor shape." />
			<Expression name="input_width" value="input.shape.size(0+index_offset)" description="Width of the input image extracted from the tensor shape." />
			<OutputSocket name="output" pipe="data" type="input.type" shape="input.shape.count == 2 ? System.Shape(count_height, count_width) : System.Shape(count_height, count_width, channels)" description="Cropped image with shape [count_height, count_width] for grayscale or [count_height, count_width, channels] for multi-channel. Has the same data type as the input."/>
		</Parameters>

		<Contracts>
			<Assert test="start_height >= 0" error="Start height must be greater than 0" />
			<Assert test="count_height >= 1" error="Crop height must be greater than 0" />
			<Assert test="start_width >= 0" error="Start width must be positive" />
			<Assert test="count_width >= 1" error="Crop width must be positive" />
			<Assert test="input.shape.count >= 2" error="Input must be at least 2D (HxW or HxWxC)." />
			<Assert test="(start_height + count_height) &lt;= input.shape.size(1+index_offset)"
				   error="Height range exceeds input dimensions ({start_height + count_height} > {input.shape.size(1+index_offset)})." />
			<Assert test="(start_width + count_width) &lt;= input.shape.size(0+index_offset)"
				   error="Width range exceeds input dimensions ({start_width + count_width} > {input.shape.size(0+index_offset)})." />
		</Contracts>

		<Implementations>
			<Implementation language="C" fragment="crop.h:crop_f32"
							  call="crop_f32(input, output, start_width, count_width, start_height, count_height, input_width, input_height, channels)">
				<Conditional value="input.type == System.Float32" />
			</Implementation>
		</Implementations>
	</Unit>
</Imaginet>