<?xml version="1.0" encoding="utf-8"?>
<Imaginet version="2.0.0.0">
	<Unit name="Imaginet.Units.Signal.ImagePadding">
		<DisplayName>Image Pad</DisplayName>
		<DisplayPath>/Image Processing/Image Manipulation</DisplayPath>
		<Description>
			<Header>Description</Header>
			Resize an image to target dimensions by center-padding with black borders or center-cropping as needed.
			
			This unit adjusts image dimensions to match a target size by combining padding and cropping operations. When the input is smaller than the target, black padding is added around the edges to center the image. When the input is larger than the target, the image is center-cropped to the target size. Both operations can occur simultaneously for different dimensions (e.g., pad height while cropping width).
			
			Input is an image tensor [H,W] or [H,W,C]. Output shape is [target_height, target_width] for grayscale or [target_height, target_width, channels] for multi-channel images.
			
			Supports float32, int8, and uint8 data types.

			<Header>Usage</Header>
			Use the Image Pad unit to prepare images for models requiring fixed input dimensions, standardize image sizes in a batch, or adjust aspect ratios while centering content.
		</Description>

		<Parameters>
			<InputSocket name="input" pipe="data" description="Input image tensor with shape [height, width] for grayscale or [height, width, channels] for multi-channel images. Supports float32, int8, and uint8 data types." />

			<Int32Option
			  name="target_height"
			  min="1"
			  ui="textbox"
			  text="Target Height"
			  description="Desired output height in pixels. If larger than input height, image is padded. If smaller, image is center-cropped." />

			<Int32Option
			  name="target_width"
			  min="1"
			  ui="textbox"
			  text="Target Width"
			  description="Desired output width in pixels. If larger than input width, image is padded. If smaller, image is center-cropped." />

			<!-- Precomputed values -->
			<Expression name="channels" value="input.shape.count == 2 ? 1 : input.shape.size(-3)" description="Number of channels in the input image (1 for grayscale, 3 for RGB)." />
			<Expression name="index_offset" value="channels == 3 ? 1 : 0" description="Internal offset for dimension indexing based on channel count." />
			<Expression name="input_height" value="input.shape.size(1+index_offset)" description="Height of the input image extracted from tensor shape." />
			<Expression name="input_width" value="input.shape.size(0+index_offset)" description="Width of the input image extracted from tensor shape." />

			<OutputSocket name="output" pipe="data" type="input.type"
						  shape="input.shape.count == 2 ? System.Shape(target_height, target_width) : System.Shape(target_height, target_width, channels)" description="Output image with shape [target_height, target_width] or [target_height, target_width, channels]. Padded areas are filled with black (0 values). Has the same data type as the input."/>
		</Parameters>

		<Contracts>
			<Assert test="input.shape.count >= 2" error="Input must be at least 2D (HxW or HxWxC)." />
			<Assert test="input_height > 0" error="Input height must be greater than 0" />
			<Assert test="input_width > 0" error="Input width must be greater than 0" />
			<Assert test="target_height > 0" error="Target height must be positive" />
			<Assert test="target_width > 0" error="Target width must be positive" />
		</Contracts>

		<Implementations>
			<Implementation language="C" fragment="image_padding.h:image_padding_f32"
							call="image_padding_f32(input, input_height, input_width, target_height, target_width, channels, output)">
				<Conditional value="input.type == System.Float32" />
			</Implementation>
			<Implementation language="C" fragment="image_padding.h:image_padding_int8"
							call="image_padding_int8(input, input_height, input_width, target_height, target_width, channels, output)">
				<Conditional value="input.type == System.Int8" />
			</Implementation>
			<Implementation language="C" fragment="image_padding.h:image_padding_uint8"
							call="image_padding_uint8(input, input_height, input_width, target_height, target_width, channels, output)">
				<Conditional value="input.type == System.UInt8" />
			</Implementation>
		</Implementations>
	</Unit>
</Imaginet>