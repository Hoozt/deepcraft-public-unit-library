<?xml version="1.0" encoding="utf-8"?>
<Imaginet version="2.0.0.0">
  <Unit name="Imaginet.Units.Signal.ScaleImage">
    <DisplayName>Image Scale</DisplayName>
    <DisplayPath>/Image Processing/Spatial Transformations</DisplayPath>
    <Description>
		<Header>Description</Header>
		Scale an image uniformly by an integer factor using pixel replication for upscaling or block averaging for downscaling.
		
		This unit multiplies or divides image dimensions by an integer scale factor while maintaining aspect ratio. Upscaling replicates each pixel scale_factor times in both dimensions (nearest neighbor). Downscaling averages blocks of scale_factor x scale_factor pixels into single output pixels for antialiasing.
		
		Input is an image tensor [H,W] or [H,W,C] where C is 1 (grayscale) or 3 (RGB). Output dimensions are input dimensions multiplied or divided by the scale factor.
		
		Supports float32 data type only.

		<Header>Usage</Header>
		Use the Image Scale unit to resize images by integer multiples, create multi-resolution pyramids, reduce image size for faster processing, or increase image size for better visualization.
	</Description>

    <Parameters>
      <InputSocket 
		    name="input" 
		    pipe="data" 
			description="Input image tensor with shape [height, width] for grayscale or [height, width, channels] for RGB (channels must be 1 or 3). Supports float32 data type only." />
		
	  <Int32Option name="scale_mode" ui="textbox" text="Scaling Mode" description="Scaling direction: Upscale (pixel replication for enlargement) or Downscale (block averaging for reduction).">
	      <OneOf>
			  <Item text="Upscale">0</Item>
			  <Item text="Downscale">1</Item>
		  </OneOf>
	  </Int32Option>
		
  	  <Int32Option
		  	name="scale_factor"
		  	text="Scale Factor"
		  	description="Integer scaling multiplier. Upscale multiplies dimensions by this factor. Downscale divides dimensions by this factor. Must be greater than or equal to 1."
	  		min="1"
	  		default="1"/>
	      
	  <Expression 
			name="y_size" 
			value="input.shape.size(-1)" 
			description="Height of the input image extracted from tensor shape." />
		  
	  <Expression 
			name="x_size" 
			value="input.shape.size(-2)" 
			description="Width of the input image extracted from tensor shape." />
	  
	  <Expression 
			name="channels" 
			value="input.shape.count == 2 ? 1 : input.shape.size(0)" 
			description="Number of channels in the input image (1 for grayscale, 3 for RGB)." />
		
	  <Expression
			name="x_output_size"
			value="scale_mode == 0 ? x_size*scale_factor : x_size/scale_factor"
			description="Computed output width. For upscale: width * scale_factor. For downscale: width / scale_factor." />

	  <Expression
			name="y_output_size"
			value="scale_mode == 0 ? y_size*scale_factor : y_size/scale_factor"
			description="Computed output height. For upscale: height * scale_factor. For downscale: height / scale_factor." />
		
		<OutputSocket 
		    name="output" 
		    pipe="data" 
		    type="input.type" 
		    shape="input.shape.replace(-1, y_output_size).replace(-2, x_output_size)"
			description="Scaled image with dimensions multiplied or divided by scale_factor. Has the same aspect ratio and data type as input."/>
		
    </Parameters>
	  
	<Contracts>
			<Assert
				test="output.shape.count == 2 || (output.shape.count == 3)"
				error="Unexpected input tensor format ({output.shape}). Expect tensor to have shape [width, height] or [width, height, channels] where channels is one or three" />
			<Assert
				test="scale_factor>=1"
				error="Negative Scale Factor." />
    </Contracts>
	  
    <Implementations>
      <Implementation language="C" fragment="upscale_image.h:upscale_image_f32" call="upscale_image_f32(input, output, scale_factor, x_size, y_size, channels)">
		  <Conditional value="(input.type == System.Float32)&amp;&amp;(scale_mode == 0)" />
      </Implementation>
		
	  <Implementation language="C" fragment="downscale_image.h:downscale_image_f32" call="downscale_image_f32(input, output, scale_factor, x_size, y_size, channels)">
	    <Conditional value="(input.type == System.Float32)&amp;&amp;(scale_mode == 1)" />
	  </Implementation>

	</Implementations>
  </Unit>
</Imaginet>