<?xml version="1.0" encoding="utf-8" ?>
<Imaginet>
	<Unit name="Imaginet.Units.Math.QShift">		
		<DisplayName>Shift</DisplayName>
		<DisplayPath>/Utilities/Quantization</DisplayPath>
		
		<Description>
			<Header>Description</Header>
			Adjust the position of the binary point in fixed-point numbers, effectively changing the scale without altering the underlying bit pattern except for saturation and truncation.
			
			This unit shifts the binary point in fixed-point arithmetic, allowing you to change the Q-format of the data. Positive shift values move the binary point to the right, while negative values move it to the left.
			
			Supports Q7, Q15, and Q31 fixed-point formats. The tensor shape is preserved, and the output maintains the same Q-format type with an adjusted shift value.

			<Header>Usage</Header>
			Use the Shift unit when you need to adjust the scale of fixed-point values to match the requirements of subsequent operations or to optimize dynamic range utilization.
		</Description>

		<Parameters>
			<InputSocket name="input" description="Input tensor in fixed-point format. Supports Q7, Q15, and Q31 data types only." />			
			<Expression name="count" value="input.shape.flat()" description="Total number of elements in the input tensor (computed from flattened shape)." />
			<Int32Option 
				name="shift" 
			description="Number of positions to move the binary point. Positive values shift right (decrease magnitude), negative values shift left (increase magnitude)." />
			<OutputSocket name="output" type="input.type" shape="input.shape" shift="input.shift + shift" description="Output tensor with adjusted binary point position. Has the same shape and Q-format type as the input, but with modified shift value." />			
		</Parameters>

		<Contracts>
			<!--<Assert test="shift &lt;= input.shift " error="Shift to big. Max is {input.shift}" />
			<Assert test="shift &gt;=  " error="Shift to small. Min is {i}" />-->
			<Assert 
				test="input.type == System.Q31 || input.type == System.Q15 || input.type == System.Q7" 
				error="QShift unit only works for quantized tensors (Q31, Q15 or Q7)" />
		</Contracts>

		<Implementations>
				
			<!-- Q31 to ... -->
			<Implementation language="C" fragment="qshift.h:qshift_q31" call="qshift_q31(input, shift, output, count)">
				<Conditional>input.type == System.Q31</Conditional>
			</Implementation>

			
			<!-- Q15 to ... -->
			<Implementation language="C" fragment="qshift.h:qshift_q15" call="qshift_q15(input, shift, output, count)">
				<Conditional>input.type == System.Q15</Conditional>
			</Implementation>

	
			<!-- Q7 to ... -->
			<Implementation language="C" fragment="qshift.h:qshift_q7" call="qshift_q7(input, shift, output, count)">
				<Conditional>input.type == System.Q7</Conditional>
			</Implementation>

		</Implementations>

	</Unit>
</Imaginet>