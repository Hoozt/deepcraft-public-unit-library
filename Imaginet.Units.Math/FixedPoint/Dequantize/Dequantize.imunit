<?xml version="1.0" encoding="utf-8" ?>
<Imaginet>
	<Unit name="Imaginet.Units.Math.Dequantize">		
		<DisplayName>Dequantize</DisplayName>
		<DisplayPath>/Utilities/Quantization</DisplayPath>
		
		<Description>
			<Header>Description</Header>
			Convert fixed-point or integer representations back to floating-point or int8 format, reversing the quantization process.
			
			This unit performs dequantization by transforming quantized data types into higher-precision representations. It supports three quantization schemes:
			- Shifted Fixed Point (Q7, Q15, Q31): Uses bit-shift scaling
			- Scaled Fixed Point (D8, D16, D32): Uses scale and offset parameters
			- Integer types (int8, int16, int32): Direct conversion
			
			The output can be either float32 for full precision or int8 for compact representation. The shift, scale, and offset parameters are automatically extracted from the input tensor metadata. The tensor shape is preserved.

			<Header>Usage</Header>
			Use the Dequantize unit when you need to convert quantized model outputs or intermediate results back to floating-point for visualization, post-processing, or interfacing with floating-point operations.
		</Description>

		<Parameters>
			<InputSocket name="input" description="Input tensor in fixed-point or integer format. Supports Q7, Q15, Q31 (shifted fixed-point), D8, D16, D32 (scaled fixed-point), and int8, int16, int32 (integer types)." />
			
			<Expression name="count" value="input.shape.flat()" description="Total number of elements in the input tensor (computed from flattened shape)." />
			
			<StringOption name="output_type" text="Output Type" description="Target data type for dequantization. Float32 provides full precision, int8 provides compact output." default="float32">
				<OneOf>
					<Item text="Float32">float32</Item>
					<Item text="Int8">int8</Item>
				</OneOf>
			</StringOption>
			
			<OutputSocket name="output" type="output_type == &quot;float32&quot; ? System.Float32 : System.Int8" shape="input.shape" description="Output tensor containing dequantized values. Has the same shape as the input but with the selected output data type." />

			<Expression name="shift" value="input.shift" description="Bit shift value extracted from the input tensor metadata (used for Q-format dequantization)." />
			<Expression name="offset" value="input.offset" description="Offset value extracted from the input tensor metadata (used for D-format dequantization)." />
			<Expression name="scale" value="input.scale" description="Scale factor extracted from the input tensor metadata (used for D-format dequantization)." />
			
		</Parameters>

	<Contracts>
		<Assert
			test="
				input.type == System.Q31 || input.type == System.Q15 ||  input.type == System.Q7 ||
				input.type == System.D32 || input.type == System.D16 ||  input.type == System.D8 ||
				input.type == System.Int8 || input.type == System.Int16 || input.type == System.Int32" 
			error="Input must be one of Q31, Q15, Q7, D32, D16, D8, Int8, Int16, Int32." />
	</Contracts>


		<Implementations>

			<!-- Float32 Output Implementations -->
			
			<!-- Shifted Fixed Point to Float32 -->
			<Implementation language="C" fragment="dequantize_q.h:dequantize_q31_to_f32" call="dequantize_q31_to_f32(input, output, count, shift)">
				<Conditional>input.type == System.Q31</Conditional>
				<Conditional>output.type == System.Float32</Conditional>
			</Implementation>
			<Implementation language="C" fragment="dequantize_q.h:dequantize_q15_to_f32" call="dequantize_q15_to_f32(input, output, count, shift)">
				<Conditional>input.type == System.Q15</Conditional>
				<Conditional>output.type == System.Float32</Conditional>
			</Implementation>
			<Implementation language="C" fragment="dequantize_q.h:dequantize_q7_to_f32" call="dequantize_q7_to_f32(input, output, count, shift)">
				<Conditional>input.type == System.Q7</Conditional>
				<Conditional>output.type == System.Float32</Conditional>
			</Implementation>

			<!-- Scaled Fixed Point to Float32 -->
			<Implementation language="C" fragment="dequantize_d.h:dequantize_d32_to_f32" call="dequantize_d32_to_f32(input, output, count, scale, offset)">
				<Conditional>input.type == System.D32</Conditional>
				<Conditional>output.type == System.Float32</Conditional>
			</Implementation>
			<Implementation language="C" fragment="dequantize_d.h:dequantize_d16_to_f32" call="dequantize_d16_to_f32(input, output, count, scale, offset)">
				<Conditional>input.type == System.D16</Conditional>
				<Conditional>output.type == System.Float32</Conditional>
			</Implementation>
			<Implementation language="C" fragment="dequantize_d.h:dequantize_d8_to_f32" call="dequantize_d8_to_f32(input, output, count, scale, offset)">
				<Conditional>input.type == System.D8</Conditional>
				<Conditional>output.type == System.Float32</Conditional>
			</Implementation>
						
			<!-- Integer to Float32 -->
			<Implementation language="C" fragment="dequantize_i.h:dequantize_i32_to_f32" call="dequantize_i32_to_f32(input, output, count)">
				<Conditional>input.type == System.Int32</Conditional>
				<Conditional>output.type == System.Float32</Conditional>
			</Implementation>
			<Implementation language="C" fragment="dequantize_i.h:dequantize_i16_to_f32" call="dequantize_i16_to_f32(input, output, count)">
				<Conditional>input.type == System.Int16</Conditional>
				<Conditional>output.type == System.Float32</Conditional>
			</Implementation>
			<Implementation language="C" fragment="dequantize_i.h:dequantize_i8_to_f32" call="dequantize_i8_to_f32(input, output, count)">
				<Conditional>input.type == System.Int8</Conditional>
				<Conditional>output.type == System.Float32</Conditional>
			</Implementation>
			
			<!-- Int8 Output Implementations -->
			
			<!-- Shifted Fixed Point to Int8 -->
			<Implementation language="C" fragment="dequantize_q.h:dequantize_q31_to_i8" call="dequantize_q31_to_i8(input, output, count, shift)">
				<Conditional>input.type == System.Q31</Conditional>
				<Conditional>output.type == System.Int8</Conditional>
			</Implementation>
			<Implementation language="C" fragment="dequantize_q.h:dequantize_q15_to_i8" call="dequantize_q15_to_i8(input, output, count, shift)">
				<Conditional>input.type == System.Q15</Conditional>
				<Conditional>output.type == System.Int8</Conditional>
			</Implementation>
			<Implementation language="C" fragment="dequantize_q.h:dequantize_q7_to_i8" call="dequantize_q7_to_i8(input, output, count, shift)">
				<Conditional>input.type == System.Q7</Conditional>
				<Conditional>output.type == System.Int8</Conditional>
			</Implementation>

			<!-- Scaled Fixed Point to Int8 -->
			<Implementation language="C" fragment="dequantize_d.h:dequantize_d32_to_i8" call="dequantize_d32_to_i8(input, output, count, scale, offset)">
				<Conditional>input.type == System.D32</Conditional>
				<Conditional>output.type == System.Int8</Conditional>
			</Implementation>
			<Implementation language="C" fragment="dequantize_d.h:dequantize_d16_to_i8" call="dequantize_d16_to_i8(input, output, count, scale, offset)">
				<Conditional>input.type == System.D16</Conditional>
				<Conditional>output.type == System.Int8</Conditional>
			</Implementation>
			<Implementation language="C" fragment="dequantize_d.h:dequantize_d8_to_i8" call="dequantize_d8_to_i8(input, output, count, scale, offset)">
				<Conditional>input.type == System.D8</Conditional>
				<Conditional>output.type == System.Int8</Conditional>
			</Implementation>

			<!-- Integer to Int8 -->
			<Implementation language="C" fragment="dequantize_i.h:dequantize_i32_to_i8" call="dequantize_i32_to_i8(input, output, count)">
				<Conditional>input.type == System.Int32</Conditional>
				<Conditional>output.type == System.Int8</Conditional>
			</Implementation>
			<Implementation language="C" fragment="dequantize_i.h:dequantize_i16_to_i8" call="dequantize_i16_to_i8(input, output, count)">
				<Conditional>input.type == System.Int16</Conditional>
				<Conditional>output.type == System.Int8</Conditional>
			</Implementation>
			<Implementation language="C" fragment="dequantize_i.h:dequantize_i8_to_i8" call="dequantize_i8_to_i8(input, output, count)">
				<Conditional>input.type == System.Int8</Conditional>
				<Conditional>output.type == System.Int8</Conditional>
			</Implementation>
		</Implementations>

	</Unit>
</Imaginet>
