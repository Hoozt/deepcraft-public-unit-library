<?xml version="1.0" encoding="utf-8" ?>
<Imaginet>
	<Unit name="Imaginet.Units.Math.BitUtilization">		
		<DisplayName>Bit Utilization</DisplayName>
		<DisplayPath>/Utilities/Quantization</DisplayPath>
		
		<Description>
			<Header>Description</Header>
			Calculate the number of bits actively used to represent each fixed-point value, excluding leading redundant sign bits.
			
			This unit analyzes fixed-point numbers to determine how many bits are actually being utilized to represent the value. It counts the bits from the least significant bit up to and including the most significant bit that differs from the sign bit. Redundant sign bits (leading bits identical to the sign bit) are not counted. This information is useful for optimizing fixed-point arithmetic and determining appropriate quantization scales.
			
			The unit operates on fixed-point formats Q7, Q15, and Q31, outputting int8 values representing the bit utilization for each element. The tensor shape is preserved.

			<Header>Usage</Header>
			Use the Bit Utilization unit when you need to analyze the dynamic range of fixed-point data to optimize quantization parameters or detect potential overflow conditions.
		</Description>

		<Parameters>
			<InputSocket name="input" description="Input tensor in fixed-point format. Supports Q7, Q15, and Q31 data types only." />			
			<Expression name="count" value="input.shape.flat()" description="Total number of elements in the input tensor (computed from flattened shape)." />
			<OutputSocket name="output" type="System.Int8" shape="input.shape" description="Output tensor containing bit utilization values (int8). Each element represents the number of bits used for the corresponding input value." />			
		</Parameters>

		<Contracts>
			<Assert 
				test="input.type == System.Q31 || input.type == System.Q15 || input.type == System.Q7" 
				error="BitUtilization unit only works for quantized tensors (Q31, Q15 or Q7)" />
		</Contracts>

		<Implementations>
				
			<!-- Q31 to ... -->
			<Implementation language="C" fragment="bit_utilization.h:bit_utilization_q31" call="bit_utilization_q31(input, output, count)">
				<Conditional>input.type == System.Q31</Conditional>
			</Implementation>

			
			<!-- Q15 to ... -->
			<Implementation language="C" fragment="bit_utilization.h:bit_utilization_q15" call="bit_utilization_q15(input, output, count)">
				<Conditional>input.type == System.Q15</Conditional>
			</Implementation>

	
			<!-- Q7 to ... -->
			<Implementation language="C" fragment="bit_utilization.h:bit_utilization_q7" call="bit_utilization_q7(input, output, count)">
				<Conditional>input.type == System.Q7</Conditional>
			</Implementation>

		</Implementations>

	</Unit>
</Imaginet>